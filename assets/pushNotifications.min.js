/*
 * Push Notifications addon for Bear Framework
 * https://github.com/ivopetkov/push-notifications-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.pushNotifications=function(){var i=null,t=null,n=function(i){for(var t=i.length,n=new Uint8Array(t),e=0;e<t;e++)n[e]=i.charCodeAt(e);return n.buffer},e=function(e){return"undefined"==typeof Promise?{then:function(i){i({code:"NOT_SUPPORTED",message:"This browser does not support promises (and other notifications related technologies)."})},catch:function(){}}:new Promise((function(s,o){var r=function(i,t,n){var e={code:i,message:t};if(void 0!==n)for(var o in n)e[o]=n[o];s(e)};null!==i&&0!==i.length||r("NO_SUBSCRIBER","No subscriber set on the server!");var c=function(i){void 0===i&&(i=null),r("UNKNOWN",null===i?"Error":"Error (details: "+i+")")};if("serviceWorker"in navigator)var u=window.setInterval((function(){"complete"===document.readyState&&(window.clearInterval(u),navigator.serviceWorker.register(t).then((function(){"showNotification"in ServiceWorkerRegistration.prototype?"denied"!==Notification.permission?"PushManager"in window?navigator.serviceWorker.ready.then((function(t){t.pushManager.getSubscription().then((function(s){var o=function(i){return JSON.stringify(i)},u=function(){clientPackages.get("serverRequests").then((function(e){e.send("ivopetkov-push-notifications-get-vapid",{}).then((function(s){var u,a=JSON.parse(s);t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n(atob((u=a.vapidPublicKey,(u+"=".repeat((4-u.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"))))}).then((function(t){e.send("ivopetkov-push-notifications-subscribe",{subscription:o(t),vapidPublicKey:a.vapidPublicKey,vapidPrivateKey:a.vapidPrivateKey,subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?r("SUBSCRIBED","The subscription is OK!",{subscriptionID:t.subscriptionID}):c()})).catch((function(i){c(i)}))})).catch((function(i){"denied"===Notification.permission?r("DENIED","The user has blocked notifications!"):"default"===Notification.permission?r("NOT_SUBSCRIBED","Not subscribed yet!"):c(i)}))})).catch((function(i){c(i)}))})).catch((function(i){c(i)}))};s?"getStatus"===e?clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-push-notifications-getid",{subscription:o(s),subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?null===t.subscriptionID?s.unsubscribe().then((function(){r("NOT_SUBSCRIBED","Not subscribed yet!")})).catch((function(i){c(i)})):r("SUBSCRIBED","The subscription is OK!",{subscriptionID:t.subscriptionID}):c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):"subscribe"===e?clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-push-notifications-getid",{subscription:o(s),subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?null===t.subscriptionID?s.unsubscribe().then((function(){u()})).catch((function(i){c(i)})):r("SUBSCRIBED","The subscription is OK!",{subscriptionID:t.subscriptionID}):c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):"unsubscribe"===e&&s.unsubscribe().then((function(t){t?clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-push-notifications-unsubscribe",{subscription:o(s),subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?r("UNSUBSCRIBED","Unsubscribe successful!"):c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):c()})).catch((function(i){c(i)})):"getStatus"===e?"denied"===Notification.permission?r("DENIED","The user has blocked notifications!"):"default"===Notification.permission||"granted"===Notification.permission?r("NOT_SUBSCRIBED","Not subscribed yet!"):c():"subscribe"===e?u():"unsubscribe"===e&&c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):r("NOT_SUPPORTED","Push messaging isn't supported in this browser!."):r("DENIED","The user has blocked notifications."):r("NOT_SUPPORTED","Notifications aren't supported in this browser!")})).catch((function(i){c(i)})))}),100);else r("NOT_SUPPORTED","Service workers aren't supported in this browser!")}))};return{initialize:function(n){void 0!==n[0]&&(i=n[0]),void 0!==n[1]&&(t=n[1])},getStatus:function(){return e("getStatus")},subscribe:function(){return e("subscribe")},unsubscribe:function(){return e("unsubscribe")}}}();