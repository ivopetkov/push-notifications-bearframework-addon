/*
 * Push Notifications addon for Bear Framework
 * https://github.com/ivopetkov/push-notifications-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{};
ivoPetkov.bearFrameworkAddons.pushNotifications=function(){var f=null,g=null,d=function(a){return"undefined"===typeof Promise?{then:function(a){a({code:"NOT_SUPPORTED",message:"This browser does not support promises (and other notifications related technologies)."})},"catch":function(){}}:new Promise(function(d,l){var b=function(b,a,e){b={code:b,message:a};if("undefined"!==typeof e)for(var c in e)b[c]=e[c];d(b)};null!==f&&0!==f.length||b("NO_SUBSCRIBER","No subscriber set on the server!");if("serviceWorker"in
navigator)var k=window.setInterval(function(){"complete"===document.readyState&&(window.clearInterval(k),navigator.serviceWorker.register(g).then(function(){"showNotification"in ServiceWorkerRegistration.prototype?"denied"===Notification.permission?b("DENIED","The user has blocked notifications."):"PushManager"in window?navigator.serviceWorker.ready.then(function(c){c.pushManager.getSubscription().then(function(h){var e=function(b){var a=b.getKey?b.getKey("p256dh"):"";a=a?btoa(String.fromCharCode.apply(null,
new Uint8Array(a))):"";var c=b.getKey?b.getKey("auth"):"";c=c?btoa(String.fromCharCode.apply(null,new Uint8Array(c))):"";return JSON.stringify({endpoint:b.endpoint,key:a,authSecret:c})},d=function(a){ivoPetkov.bearFrameworkAddons.serverRequests.send("ivopetkov-push-notifications-subscribe",{subscription:e(a),subscriberKey:f},function(a){a=JSON.parse(a);"undefined"!==typeof a.status&&"ok"===a.status?b("SUBSCRIBED","The subscription is OK!",{subscriptionID:a.subscriptionID}):b("UNKNOWN","Cannot subsribe on the server!")})};
if(h)if("getStatus"===a||"subscribe"===a)d(h);else{if("unsubscribe"===a){var g=e(h);h.unsubscribe().then(function(a){a?ivoPetkov.bearFrameworkAddons.serverRequests.send("ivopetkov-push-notifications-unsubscribe",{subscription:g,subscriberKey:f},function(a){a=JSON.parse(a);"undefined"!==typeof a.status&&"ok"===a.status?b("UNSUBSCRIBED","Unsubscribe successful!"):b("UNKNOWN","Cannot unsubsribe from the server!")}):b("UNKNOWN","Unknown unsubscribe error!")})["catch"](function(a){b("UNKNOWN","Unknown unsubscribe error!")})}}else"getStatus"===
a?"denied"===Notification.permission?b("DENIED","The user has blocked notifications!"):"default"===Notification.permission||"granted"===Notification.permission?b("NOT_SUBSCRIBED","Not subscribed yet!"):b("UNKNOWN","Unknown error (unknown status)!"):"subscribe"===a?c.pushManager.subscribe({userVisibleOnly:!0}).then(function(a){d(a)})["catch"](function(a){"denied"===Notification.permission?b("DENIED","The user has blocked notifications!"):"default"===Notification.permission?b("NOT_SUBSCRIBED","Not subscribed yet!"):
b("UNKNOWN","Unknown error (details: "+a+")!")}):"unsubscribe"===a&&b("UNKNOWN","Subscription not found!")})["catch"](function(a){b("UNKNOWN","Unknown error (details: "+JSON.stringify(a)+")!")})})["catch"](function(a){b("UNKNOWN","Unknown error (details: "+JSON.stringify(a)+")!")}):b("NOT_SUPPORTED","Push messaging isn't supported in this browser!."):b("NOT_SUPPORTED","Notifications aren't supported in this browser!")})["catch"](function(a){b("UNKNOWN","Unknown error (details: "+JSON.stringify(a)+
")!")}))},100);else b("NOT_SUPPORTED","Service workers aren't supported in this browser!")})};return{initialize:function(a){"undefined"!==typeof a[0]&&(f=a[0]);"undefined"!==typeof a[1]&&(g=a[1])},getStatus:function(){return d("getStatus")},subscribe:function(){return d("subscribe")},unsubscribe:function(){return d("unsubscribe")}}}();