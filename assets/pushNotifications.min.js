/*
 * Push Notifications addon for Bear Framework
 * https://github.com/ivopetkov/push-notifications-bearframework-addon
 * Copyright (c) 2018 Ivo Petkov
 * Free to use under the MIT license.
 */

var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{};
ivoPetkov.bearFrameworkAddons.pushNotifications=function(){var d=null,e=null,c=function(a){return"undefined"===typeof Promise?{then:function(a){a({code:"NOT_SUPPORTED",message:"This browser does not support promises (and other notifications related technologies)."})},"catch":function(){}}:new Promise(function(c,l){var b=function(b,a){c({code:b,message:a})};null!==d&&0!==d.length||b("NO_SUBSCRIBER","No subscriber set on the server!");if("serviceWorker"in navigator)var h=window.setInterval(function(){"complete"===
document.readyState&&(window.clearInterval(h),navigator.serviceWorker.register(e).then(function(){"showNotification"in ServiceWorkerRegistration.prototype?"denied"===Notification.permission?b("DENIED","The user has blocked notifications."):"PushManager"in window?navigator.serviceWorker.ready.then(function(k){k.pushManager.getSubscription().then(function(f){var c=function(b){var a=b.getKey?b.getKey("p256dh"):"";a=a?btoa(String.fromCharCode.apply(null,new Uint8Array(a))):"";var g=b.getKey?b.getKey("auth"):
"";g=g?btoa(String.fromCharCode.apply(null,new Uint8Array(g))):"";return JSON.stringify({endpoint:b.endpoint,key:a,authSecret:g})},e=function(a){ivoPetkov.bearFrameworkAddons.serverRequests.send("ivopetkov-push-notifications-subscribe",{subscription:c(a),subscriberKey:d},function(a){"1"===a?b("SUBSCRIBED","The subscription is OK!"):b("UNKNOWN","Cannot subsribe on the server!")})};if(f)if("getStatus"===a||"subscribe"===a)e(f);else{if("unsubscribe"===a){var h=c(f);f.unsubscribe().then(function(a){a?
ivoPetkov.bearFrameworkAddons.serverRequests.send("ivopetkov-push-notifications-unsubscribe",{subscription:h,subscriberKey:d},function(a){"1"===a?b("UNSUBSCRIBED","Unsubscribe successful!"):b("UNKNOWN","Cannot unsubsribe from the server!")}):b("UNKNOWN","Unknown unsubscribe error!")})["catch"](function(a){b("UNKNOWN","Unknown unsubscribe error!")})}}else"getStatus"===a?"denied"===Notification.permission?b("DENIED","The user has blocked notifications!"):"default"===Notification.permission||"granted"===
Notification.permission?b("NOT_SUBSCRIBED","Not subscribed yet!"):b("UNKNOWN","Unknown error (unknown status)!"):"subscribe"===a?k.pushManager.subscribe({userVisibleOnly:!0}).then(function(a){e(a)})["catch"](function(a){"denied"===Notification.permission?b("DENIED","The user has blocked notifications!"):"default"===Notification.permission?b("NOT_SUBSCRIBED","Not subscribed yet!"):b("UNKNOWN","Unknown error (details: "+a+")!")}):"unsubscribe"===a&&b("UNKNOWN","Subscription not found!")})["catch"](function(a){b("UNKNOWN",
"Unknown error (details: "+JSON.stringify(a)+")!")})})["catch"](function(a){b("UNKNOWN","Unknown error (details: "+JSON.stringify(a)+")!")}):b("NOT_SUPPORTED","Push messaging isn't supported in this browser!."):b("NOT_SUPPORTED","Notifications aren't supported in this browser!")})["catch"](function(a){b("UNKNOWN","Unknown error (details: "+JSON.stringify(a)+")!")}))},100);else b("NOT_SUPPORTED","Service workers aren't supported in this browser!")})};return{initialize:function(a){"undefined"!==typeof a[0]&&
(d=a[0]);"undefined"!==typeof a[1]&&(e=a[1])},getStatus:function(){return c("getStatus")},subscribe:function(){return c("subscribe")},unsubscribe:function(){return c("unsubscribe")}}}();