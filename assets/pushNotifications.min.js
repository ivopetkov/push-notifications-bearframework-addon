/*
 * Push Notifications addon for Bear Framework
 * https://github.com/ivopetkov/push-notifications-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.pushNotifications=function(){var i=null,t=null,e=function(i){for(var t=i.length,e=new Uint8Array(t),n=0;n<t;n++)e[n]=i.charCodeAt(n);return e.buffer},n=function(n){return"undefined"==typeof Promise?{then:function(i){i({code:"NOT_SUPPORTED",message:"This browser does not support promises (and other notifications related technologies)."})},catch:function(){}}:new Promise((function(s,o){var r=function(i,t,e){var n={code:i,message:t};if(void 0!==e)for(var o in e)n[o]=e[o];s(n)};if(null!==i&&0!==i.length||r("NO_SUBSCRIBER","No subscriber set on the server!"),"serviceWorker"in navigator)var c=window.setInterval((function(){"complete"===document.readyState&&(window.clearInterval(c),navigator.serviceWorker.register(t).then((function(){"showNotification"in ServiceWorkerRegistration.prototype?"denied"!==Notification.permission?"PushManager"in window?navigator.serviceWorker.ready.then((function(t){t.pushManager.getSubscription().then((function(s){var o=function(i){return JSON.stringify(i)},c=function(i){void 0===i&&(i=null),r("UNKNOWN",null===i?"Error":"Error (details: "+i+")")};s?"getStatus"===n?clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-push-notifications-getid",{subscription:o(s),subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?null===t.subscriptionID?s.unsubscribe().then((function(){r("NOT_SUBSCRIBED","Not subscribed yet!")})).catch((function(i){c(i)})):r("SUBSCRIBED","The subscription is OK!",{subscriptionID:t.subscriptionID}):c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):"unsubscribe"===n&&s.unsubscribe().then((function(t){t?clientPackages.get("serverRequests").then((function(t){t.send("ivopetkov-push-notifications-unsubscribe",{subscription:o(s),subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?r("UNSUBSCRIBED","Unsubscribe successful!"):c()})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):c()})).catch((function(i){c(i)})):"getStatus"===n?"denied"===Notification.permission?r("DENIED","The user has blocked notifications!"):"default"===Notification.permission||"granted"===Notification.permission?r("NOT_SUBSCRIBED","Not subscribed yet!"):c():"subscribe"===n?clientPackages.get("serverRequests").then((function(n){n.send("ivopetkov-push-notifications-get-vapid",{}).then((function(s){var u,a=JSON.parse(s);t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e(atob((u=a.vapidPublicKey,(u+"=".repeat((4-u.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"))))}).then((function(t){n.send("ivopetkov-push-notifications-subscribe",{subscription:o(t),vapidPublicKey:a.vapidPublicKey,vapidPrivateKey:a.vapidPrivateKey,subscriberKey:i}).then((function(i){var t=JSON.parse(i);void 0!==t.status&&"ok"===t.status?r("SUBSCRIBED","The subscription is OK!",{subscriptionID:t.subscriptionID}):c()})).catch((function(i){c(i)}))})).catch((function(i){"denied"===Notification.permission?r("DENIED","The user has blocked notifications!"):"default"===Notification.permission?r("NOT_SUBSCRIBED","Not subscribed yet!"):c(i)}))})).catch((function(i){c(i)}))})).catch((function(i){c(i)})):"unsubscribe"===n&&c()})).catch((function(i){respondWithError(i)}))})).catch((function(i){respondWithError(i)})):r("NOT_SUPPORTED","Push messaging isn't supported in this browser!."):r("DENIED","The user has blocked notifications."):r("NOT_SUPPORTED","Notifications aren't supported in this browser!")})).catch((function(i){respondWithError(i)})))}),100);else r("NOT_SUPPORTED","Service workers aren't supported in this browser!")}))};return{initialize:function(e){void 0!==e[0]&&(i=e[0]),void 0!==e[1]&&(t=e[1])},getStatus:function(){return n("getStatus")},subscribe:function(){return n("subscribe")},unsubscribe:function(){return n("unsubscribe")}}}();